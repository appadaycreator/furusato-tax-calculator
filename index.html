<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Åµ„Çã„Åï„Å®Á¥çÁ®éÈôêÂ∫¶È°çË®àÁÆó„ÉÑ„Éº„É´ | 30Êó•ÈÄ£Á∂öÈñãÁô∫„ÉÅ„É£„É¨„É≥„Ç∏</title>
    <meta name="description" content="Âπ¥Âèé„Åã„Çâ1„ÇØ„É™„ÉÉ„ÇØ„Åß„Åµ„Çã„Åï„Å®Á¥çÁ®é„ÅÆÈôêÂ∫¶È°ç„ÇíÊ≠£Á¢∫Ë®àÁÆóÔºÅÁ®éÂà∂„Å´Âü∫„Å•„ÅÑ„ÅüË©≥Á¥∞ÂàÜÊûê„Å®AI„Ç¢„Éâ„Éê„Ç§„Çπ„ÅßÊúÄÈÅ©„Å™ÂØÑ‰ªò„Éó„É©„É≥„ÇíÊèêÊ°à„ÄÇÁÑ°Êñô„Åß‰Ωø„Åà„Çã„Éó„É¨„Éü„Ç¢„É†Ë®àÁÆó„ÉÑ„Éº„É´„ÄÇ">
    <meta name="keywords" content="„Åµ„Çã„Åï„Å®Á¥çÁ®é,ÈôêÂ∫¶È°ç,Ë®àÁÆó,Á®éÈáë,ÊéßÈô§,ÁØÄÁ®é,Âπ¥Âèé,ÂÆ∂ÊóèÊßãÊàê">
    <meta name="robots" content="index, follow">
    <meta name="author" content="AppADayCreator">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://appadaycreator.github.io/furusato-tax-calculator/">
    <meta property="og:title" content="„Åµ„Çã„Åï„Å®Á¥çÁ®éÈôêÂ∫¶È°çË®àÁÆó„ÉÑ„Éº„É´ | ÁÑ°Êñô„ÅßÊ≠£Á¢∫Ë®àÁÆó">
    <meta property="og:description" content="Âπ¥ÂèéÂÖ•Âäõ„ÅßÁû¨ÊôÇ„Å´ÈôêÂ∫¶È°ç„ÇíË®àÁÆóÔºÅAIÂàÜÊûê„Å®„Éì„Ç∏„É•„Ç¢„É´Âåñ„ÅßÊúÄÈÅ©„Å™„Åµ„Çã„Åï„Å®Á¥çÁ®é„Çí„Çµ„Éù„Éº„Éà">
    <meta property="og:image" content="https://appadaycreator.github.io/furusato-tax-calculator/og-image.jpg">
    <meta property="og:site_name" content="„Åµ„Çã„Åï„Å®Á¥çÁ®éË®àÁÆó„ÉÑ„Éº„É´">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://appadaycreator.github.io/furusato-tax-calculator/">
    <meta name="twitter:title" content="„Åµ„Çã„Åï„Å®Á¥çÁ®éÈôêÂ∫¶È°çË®àÁÆó„ÉÑ„Éº„É´">
    <meta name="twitter:description" content="Âπ¥Âèé„Åã„Çâ1„ÇØ„É™„ÉÉ„ÇØ„ÅßÈôêÂ∫¶È°ç„ÇíÊ≠£Á¢∫Ë®àÁÆóÔºÅ">
    <meta name="twitter:image" content="https://appadaycreator.github.io/furusato-tax-calculator/og-image.jpg">
    <meta name="twitter:creator" content="@appadaycreator">

    <!-- Canonical -->
    <link rel="canonical" href="https://appadaycreator.github.io/furusato-tax-calculator/">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèõÔ∏è</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèõÔ∏è</text></svg>">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js" as="script">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TXQGZRF9');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "„Åµ„Çã„Åï„Å®Á¥çÁ®éÈôêÂ∫¶È°çË®àÁÆó„ÉÑ„Éº„É´",
        "description": "Âπ¥Âèé„Åã„Çâ1„ÇØ„É™„ÉÉ„ÇØ„Åß„Åµ„Çã„Åï„Å®Á¥çÁ®é„ÅÆÈôêÂ∫¶È°ç„ÇíÊ≠£Á¢∫Ë®àÁÆó",
        "url": "https://appadaycreator.github.io/furusato-tax-calculator/",
        "applicationCategory": "FinanceApplication",
        "operatingSystem": "Any",
        "browserRequirements": "Modern browser with JavaScript enabled",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "JPY"
        },
        "creator": {
            "@type": "Person",
            "name": "AppADayCreator"
        }
    }
    </script>

    <style>
        /* CSS Custom Properties for Consistent Design */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            
            --border-radius: 15px;
            --border-radius-small: 8px;
            --border-radius-large: 20px;
            
            --shadow-small: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-medium: 0 8px 30px rgba(0,0,0,0.12);
            --shadow-large: 0 15px 35px rgba(0,0,0,0.1);
            
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            
            --font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 2rem;
            --font-size-4xl: 2.5rem;
        }

        /* CSS Reset */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Base Styles */
        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--primary-gradient);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Layout Components */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            margin-bottom: 2rem;
        }

        /* Header Component */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideInDown 0.8s ease-out;
        }

        .header__title {
            font-size: var(--font-size-4xl);
            font-weight: 800;
            margin-bottom: 1rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            line-height: 1.2;
        }

        .header__subtitle {
            font-size: var(--font-size-lg);
            color: rgba(255,255,255,0.9);
            font-weight: 300;
            margin-bottom: 1rem;
        }

        .header__badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: var(--font-size-sm);
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        /* Card Components */
        .card {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-large);
            position: relative;
            overflow: hidden;
            animation: slideInUp 0.8s ease-out;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .card__header {
            margin-bottom: 2rem;
        }

        .card__title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .card__subtitle {
            color: var(--text-secondary);
            font-size: var(--font-size-base);
        }

        /* Form Components */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        .form-label__icon {
            margin-right: 0.5rem;
            font-size: var(--font-size-base);
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            font-size: var(--font-size-base);
            transition: all var(--transition-normal);
            background: #fff;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 12px;
            padding-right: 3rem;
        }

        /* Checkbox Component */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox {
            position: relative;
            width: 20px;
            height: 20px;
        }

        .checkbox input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkbox__mark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #eee;
            border-radius: 4px;
            transition: all var(--transition-normal);
        }

        .checkbox input:checked ~ .checkbox__mark {
            background: var(--primary-gradient);
        }

        .checkbox__mark:after {
            content: "";
            position: absolute;
            display: none;
            left: 7px;
            top: 3px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        .checkbox input:checked ~ .checkbox__mark:after {
            display: block;
        }

        /* Button Components */
        .btn {
            display: inline-block;
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--font-size-base);
            font-weight: 600;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .btn--primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn--secondary {
            background: var(--secondary-gradient);
            color: white;
        }

        .btn--large {
            width: 100%;
            padding: 1.25rem 2rem;
            font-size: var(--font-size-lg);
            margin-top: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        /* Result Components */
        .result-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .result-card {
            background: var(--secondary-gradient);
            color: white;
            border-radius: var(--border-radius-large);
            padding: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        .result-amount {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .result-title {
            font-size: var(--font-size-xl);
            margin-bottom: 2rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
            position: relative;
            z-index: 1;
        }

        .result-item {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            transition: transform var(--transition-normal);
        }

        .result-item:hover {
            transform: translateY(-5px);
        }

        .result-item__label {
            font-size: var(--font-size-sm);
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .result-item__value {
            font-size: var(--font-size-xl);
            font-weight: 700;
        }

        /* AI Assistant Component */
        .ai-assistant {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: none;
            animation: slideInLeft 0.5s ease-out;
        }

        .ai-assistant__header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ai-assistant__avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #10b981, #3b82f6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .ai-assistant__content {
            line-height: 1.6;
            color: var(--text-secondary);
        }

        /* Affiliate Section */
        .affiliate-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-top: 2rem;
            text-align: center;
        }

        .affiliate-title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .affiliate-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .affiliate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .affiliate-card {
            background: white;
            border: 2px solid #f1f5f9;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-decoration: none;
            color: inherit;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .affiliate-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .affiliate-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
            border-color: #667eea;
        }

        .affiliate-card:hover::before {
            opacity: 0.05;
        }

        .affiliate-card__icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .affiliate-card__title {
            font-size: var(--font-size-lg);
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .affiliate-card__description {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .affiliate-card__cta {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--primary-gradient);
            color: white;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            font-size: var(--font-size-sm);
            text-decoration: none;
            transition: all var(--transition-normal);
            position: relative;
            z-index: 1;
        }

        .affiliate-card__cta:hover {
            transform: scale(1.05);
        }

        /* Chart Container */
        .chart-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-title {
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Share Section */
        .share-section {
            text-align: center;
            margin-top: 2rem;
        }

        .share-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: 1rem;
            color: white;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .share-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            text-decoration: none;
            color: white;
            backdrop-filter: blur(10px);
        }

        .share-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        /* History Section */
        .history-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-top: 2rem;
        }

        .history-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            flex: 1;
        }

        .history-date {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
        }

        .history-details {
            font-weight: 600;
            color: var(--text-primary);
        }

        .history-amount {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: #667eea;
        }

        .clear-history-btn {
            margin-top: 1rem;
            background: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all var(--transition-normal);
        }

        .clear-history-btn:hover {
            background: #dc2626;
        }

        /* Loading Component */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            border: 3px solid rgba(102, 126, 234, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: var(--font-size-lg);
        }

        /* Animations */
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header__title {
                font-size: var(--font-size-3xl);
            }

            .card {
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .result-amount {
                font-size: 3rem;
            }

            .affiliate-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .share-buttons {
                flex-wrap: wrap;
            }
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            .card {
                border: 2px solid var(--text-primary);
            }

            .form-input {
                border: 2px solid var(--text-primary);
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }

            .card {
                background: white;
                box-shadow: none;
                border: 1px solid #ddd;
            }

            .btn, .share-section, .affiliate-section {
                display: none;
            }

            .result-card {
                background: white;
                color: black;
                border: 2px solid #ddd;
            }
        }

        /* Error States */
        .form-input--error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .error-message {
            color: #ef4444;
            font-size: var(--font-size-sm);
            margin-top: 0.25rem;
        }

        /* Success States */
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 1rem;
            border-radius: var(--border-radius-small);
            margin-bottom: 1rem;
            border: 1px solid #a7f3d0;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .hidden { display: none; }
        .visible { display: block; }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TXQGZRF9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="header__title">üèõÔ∏è „Åµ„Çã„Åï„Å®Á¥çÁ®éÈôêÂ∫¶È°çË®àÁÆó„ÉÑ„Éº„É´</h1>
            <p class="header__subtitle">Âπ¥Âèé„Åã„Çâ1„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≠£Á¢∫„Å™ÈôêÂ∫¶È°ç„ÇíË®àÁÆó</p>
        </header>

        <!-- Main Calculator -->
        <section class="section">
            <div class="card">
                <div class="card__header">
                    <h2 class="card__title">üìä Ë®àÁÆó„Éï„Ç©„Éº„É†</h2>
                    <p class="card__subtitle">„ÅÇ„Å™„Åü„ÅÆÊÉÖÂ†±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>

                <form id="taxForm" novalidate>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="income" class="form-label">
                                <span class="form-label__icon">üí∞</span>
                                Âπ¥ÂèéÔºà‰∏áÂÜÜÔºâ
                            </label>
                            <input 
                                type="number" 
                                id="income" 
                                name="income"
                                class="form-input" 
                                placeholder="‰æã: 500" 
                                required 
                                min="1" 
                                max="10000"
                                aria-describedby="income-error"
                            >
                            <div id="income-error" class="error-message" role="alert"></div>
                        </div>

                        <div class="form-group">
                            <label for="family" class="form-label">
                                <span class="form-label__icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                                ÂÆ∂ÊóèÊßãÊàê
                            </label>
                            <select 
                                id="family" 
                                name="family"
                                class="form-input form-select" 
                                required
                                aria-describedby="family-error"
                            >
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="single">Áã¨Ë∫´„ÉªÂÖ±ÂÉç„Åç</option>
                                <option value="married_working">Â§´Â©¶ÂÖ±ÂÉç„Åç</option>
                                <option value="married_housewife">Â§´Â©¶ÔºàÈÖçÂÅ∂ËÄÖÊéßÈô§„ÅÇ„ÇäÔºâ</option>
                                <option value="married_child1">Â§´Â©¶+Â≠ê1‰∫∫Ôºà19Ê≠≥‰ª•‰∏ãÔºâ</option>
                                <option value="married_child2">Â§´Â©¶+Â≠ê2‰∫∫Ôºà19Ê≠≥‰ª•‰∏ãÔºâ</option>
                                <option value="married_college1">Â§´Â©¶+Â§ßÂ≠¶Áîü1‰∫∫</option>
                            </select>
                            <div id="family-error" class="error-message" role="alert"></div>
                        </div>

                        <div class="form-group">
                            <label for="socialInsurance" class="form-label">
                                <span class="form-label__icon">üè•</span>
                                Á§æ‰ºö‰øùÈô∫ÊñôÊéßÈô§Ôºà‰∏áÂÜÜÔºâ
                            </label>
                            <input 
                                type="number" 
                                id="socialInsurance" 
                                name="socialInsurance"
                                class="form-input" 
                                placeholder="Ëá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åô" 
                                min="0" 
                                max="500"
                            >
                        </div>

                        <div class="form-group">
                            <label for="lifeInsurance" class="form-label">
                                <span class="form-label__icon">üõ°Ô∏è</span>
                                ÁîüÂëΩ‰øùÈô∫ÊñôÊéßÈô§Ôºà‰∏áÂÜÜÔºâ
                            </label>
                            <input 
                                type="number" 
                                id="lifeInsurance" 
                                name="lifeInsurance"
                                class="form-input" 
                                placeholder="‰æã: 12" 
                                value="0"
                                min="0" 
                                max="50"
                            >
                        </div>

                        <div class="form-group">
                            <label for="medicalExpense" class="form-label">
                                <span class="form-label__icon">üíä</span>
                                ÂåªÁôÇË≤ªÊéßÈô§Ôºà‰∏áÂÜÜÔºâ
                            </label>
                            <input 
                                type="number" 
                                id="medicalExpense" 
                                name="medicalExpense"
                                class="form-input" 
                                placeholder="‰æã: 10" 
                                value="0"
                                min="0" 
                                max="200"
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <span class="form-label__icon">üè†</span>
                                „Åù„ÅÆ‰ªñ„ÅÆÊéßÈô§
                            </label>
                            <div class="checkbox-group">
                                <label class="checkbox">
                                    <input type="checkbox" id="housingLoan" name="housingLoan">
                                    <span class="checkbox__mark"></span>
                                </label>
                                <span>‰ΩèÂÆÖ„É≠„Éº„É≥ÊéßÈô§„ÅÇ„Çä</span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn--primary btn--large">
                        üöÄ ÈôêÂ∫¶È°ç„ÇíË®àÁÆó„Åô„Çã
                    </button>
                </form>

                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">Ë®àÁÆó‰∏≠...</p>
                </div>
            </div>
        </section>

        <!-- Result Section -->
        <div class="result-section" id="resultSection">
            <!-- AI Assistant -->
            <div class="ai-assistant" id="aiAssistant">
                <div class="ai-assistant__header">
                    <div class="ai-assistant__avatar">ü§ñ</div>
                    <div>
                        <h3>AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åã„Çâ„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ</h3>
                    </div>
                </div>
                <div class="ai-assistant__content" id="aiAdvice">
                    ÂàÜÊûêÁµêÊûú„Å´Âü∫„Å•„ÅÑ„ÅüÊúÄÈÅ©„Å™„Åµ„Çã„Åï„Å®Á¥çÁ®é„Éó„É©„É≥„Çí„ÅîÊèêÊ°à„Åó„Åæ„Åô„ÄÇ
                </div>
            </div>

            <!-- Main Result -->
            <div class="result-card">
                <div class="result-amount" id="resultAmount">¬•0</div>
                <p class="result-title">„Åµ„Çã„Åï„Å®Á¥çÁ®éÈôêÂ∫¶È°ç</p>

                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-item__label">ÂÆüË≥™Ë≤†ÊãÖÈ°ç</div>
                        <div class="result-item__value">¬•2,000</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item__label">Êé®Â•®ÂØÑ‰ªòÈ°ç</div>
                        <div class="result-item__value" id="recommendAmount">¬•0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item__label">ÁØÄÁ®éÂäπÊûú</div>
                        <div class="result-item__value" id="taxSaving">¬•0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-item__label">ÂÆüË≥™ÈÇÑÂÖÉÁéá</div>
                        <div class="result-item__value" id="returnRate">0%</div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="chart-section">
                <h3 class="card__title text-center">üìà Ë©≥Á¥∞ÂàÜÊûê„ÉÅ„É£„Éº„Éà</h3>
                <div class="chart-grid">
                    <div>
                        <h4 class="chart-title">Á®éÈáë„ÅÆÂÜÖË®≥</h4>
                        <div class="chart-container">
                            <canvas id="taxChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="chart-title">ÁØÄÁ®éÂäπÊûú„ÅÆÊØîËºÉ</h4>
                        <div class="chart-container">
                            <canvas id="savingChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Affiliate Section -->
            <div class="affiliate-section">
                <h3 class="affiliate-title">üéÅ „Åä„Åô„Åô„ÇÅ„Åµ„Çã„Åï„Å®Á¥çÁ®é„Çµ„Ç§„Éà</h3>
                <p class="affiliate-subtitle">Ë®àÁÆó„Åó„ÅüÈôêÂ∫¶È°ç„Åß„ÅäÂæó„Å™ËøîÁ§ºÂìÅ„ÇíË¶ã„Å§„Åë„Çà„ÅÜÔºÅ</p>
                
                <div class="affiliate-grid">
                    <a href="https://www.satofull.jp/" 
                       target="_blank" 
                       rel="noopener" 
                       class="affiliate-card"
                       onclick="trackAffiliateClick('satofull')">
                        <span class="affiliate-card__icon">üåæ</span>
                        <h4 class="affiliate-card__title">„Åï„Å®„Åµ„Çã</h4>
                        <p class="affiliate-card__description">
                            ËøîÁ§ºÂìÅÊï∞No.1ÔºÅÈÖçÈÄÅ„ÅåÊó©„Åè„ÄÅÂàùÂøÉËÄÖ„Å´„ÇÇ‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ„Çµ„Ç§„Éà„Åß„Åô„ÄÇ
                        </p>
                        <span class="affiliate-card__cta">‰ªä„Åô„Åê„ÉÅ„Çß„ÉÉ„ÇØ ‚Üí</span>
                    </a>

                    <a href="https://hb.afl.rakuten.co.jp/hgc/0ccb3a41.4fac7d3c.0ccb3a44.0dc57066/?pc=https%3A%2F%2Fevent.rakuten.co.jp%2Ffurusato%2F&link_type=text&ut=eyJwYWdlIjoidXJsIiwidHlwZSI6InRleHQiLCJjb2wiOjF9" 
                       target="_blank" 
                       rel="nofollow sponsored noopener" 
                       class="affiliate-card"
                       onclick="trackAffiliateClick('rakuten')">
                        <span class="affiliate-card__icon">üõçÔ∏è</span>
                        <h4 class="affiliate-card__title">Ê•ΩÂ§©„Åµ„Çã„Åï„Å®Á¥çÁ®é</h4>
                        <p class="affiliate-card__description">
                            Ê•ΩÂ§©„Éù„Ç§„É≥„Éà„ÅåË≤Ø„Åæ„Çã„Éª‰Ωø„Åà„ÇãÔºÅÊúÄÂ§ß30%„Éù„Ç§„É≥„ÉàÈÇÑÂÖÉ„Åß„ÅäÂæó„ÄÇ
                        </p>
                        <span class="affiliate-card__cta">‰ªä„Åô„Åê„ÉÅ„Çß„ÉÉ„ÇØ ‚Üí</span>
                    </a>

                    <a href="https://furunavi.jp/" 
                       target="_blank" 
                       rel="noopener" 
                       class="affiliate-card"
                       onclick="trackAffiliateClick('furunavi')">
                        <span class="affiliate-card__icon">üè†</span>
                        <h4 class="affiliate-card__title">„Åµ„Çã„Å™„Å≥</h4>
                        <p class="affiliate-card__description">
                            ÂÆ∂ÈõªËøîÁ§ºÂìÅ„ÅåÂÖÖÂÆüÔºÅAmazon„ÇÆ„Éï„ÉàÂà∏ÈÇÑÂÖÉ„Åß„Åï„Çâ„Å´„ÅäÂæó„ÄÇ
                        </p>
                        <span class="affiliate-card__cta">‰ªä„Åô„Åê„ÉÅ„Çß„ÉÉ„ÇØ ‚Üí</span>
                    </a>
                </div>

                <div class="success-message" id="affiliateMessage" style="display: none;">
                    üí° <strong>„ÅäÂæóÊÉÖÂ†±Ôºö</strong>Âπ¥Êú´„Åæ„Åß„ÅÆÂØÑ‰ªò„Åß‰ªäÂπ¥„ÅÆÊéßÈô§„ÅåÂèó„Åë„Çâ„Çå„Åæ„ÅôÔºÅ
                </div>
            </div>

            <!-- Share Section -->
            <div class="share-section">
                <h3 class="share-title">üì± ÁµêÊûú„Çí„Ç∑„Çß„Ç¢</h3>
                <div class="share-buttons">
                    <a href="#" class="share-btn" onclick="shareTwitter()" aria-label="Twitter„Åß„Ç∑„Çß„Ç¢">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
                        </svg>
                    </a>
                    <a href="#" class="share-btn" onclick="shareFacebook()" aria-label="Facebook„Åß„Ç∑„Çß„Ç¢">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
                        </svg>
                    </a>
                    <a href="#" class="share-btn" onclick="shareLine()" aria-label="LINE„Åß„Ç∑„Çß„Ç¢">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21.812 10.975c0-4.597-4.626-8.347-10.312-8.347S1.188 6.378 1.188 10.975c0 4.121 3.668 7.572 8.624 8.223.336.072.794.221.91.507.104.259.068.665.033.925l-.146.877c-.045.262-.205 1.025.898.559 1.103-.466 5.956-3.506 8.123-6.002 1.498-1.664 2.182-3.352 2.182-5.089z"></path>
                        </svg>
                    </a>
                    <button class="share-btn" onclick="copyLink()" aria-label="„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="history-section">
            <h3 class="history-title">üìà Ë®àÁÆóÂ±•Ê≠¥</h3>
            <div class="history-list" id="historyList">
                <p class="text-center" style="color: #999;">„Åæ„Å†Ë®àÁÆóÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
            </div>
            <button id="clearHistoryBtn" class="clear-history-btn" style="display: none;">Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢</button>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>

    <script>
        'use strict';

        // Application Configuration
        const CONFIG = {
            TAX_BRACKETS: [
                { min: 0, max: 1950000, rate: 0.05, deduction: 0 },
                { min: 1950000, max: 3300000, rate: 0.10, deduction: 97500 },
                { min: 3300000, max: 6950000, rate: 0.20, deduction: 427500 },
                { min: 6950000, max: 9000000, rate: 0.23, deduction: 636000 },
                { min: 9000000, max: 18000000, rate: 0.33, deduction: 1536000 },
                { min: 18000000, max: 40000000, rate: 0.40, deduction: 2796000 },
                { min: 40000000, max: Infinity, rate: 0.45, deduction: 4796000 }
            ],
            FAMILY_DEDUCTIONS: {
                'single': 480000,
                'married_working': 480000,
                'married_housewife': 480000 + 380000,
                'married_child1': 480000 + 380000 + 380000,
                'married_child2': 480000 + 380000 + 380000 * 2,
                'married_college1': 480000 + 380000 + 630000
            },
            STORAGE_KEY: 'furusatoCalculatorHistory',
            MAX_HISTORY_ITEMS: 5
        };

        // Application State
        let app = {
            charts: {
                tax: null,
                saving: null
            },
            history: [],
            currentResult: null
        };

        // DOM Elements
        const elements = {
            form: document.getElementById('taxForm'),
            loading: document.getElementById('loading'),
            resultSection: document.getElementById('resultSection'),
            resultAmount: document.getElementById('resultAmount'),
            recommendAmount: document.getElementById('recommendAmount'),
            taxSaving: document.getElementById('taxSaving'),
            returnRate: document.getElementById('returnRate'),
            aiAssistant: document.getElementById('aiAssistant'),
            aiAdvice: document.getElementById('aiAdvice'),
            historyList: document.getElementById('historyList'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            affiliateMessage: document.getElementById('affiliateMessage'),
            taxChart: document.getElementById('taxChart'),
            savingChart: document.getElementById('savingChart')
        };

        // Utility Functions
        const utils = {
            formatCurrency: (amount) => `¬•${Math.floor(amount).toLocaleString()}`,
            formatNumber: (number) => Math.floor(number).toLocaleString(),
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            showNotification: (message, type = 'info') => {
                const notification = document.createElement('div');
                notification.className = `notification notification--${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${type === 'error' ? '#ef4444' : '#10b981'};
                    color: white;
                    padding: 1rem 2rem;
                    border-radius: 10px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    z-index: 10000;
                    animation: slideInDown 0.5s ease-out;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideInUp 0.5s ease-out';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            }
        };

        // Validation Module
        const validation = {
            rules: {
                income: {
                    required: true,
                    min: 1,
                    max: 10000,
                    message: 'Âπ¥Âèé„ÅØ1‰∏áÂÜÜ‰ª•‰∏ä1ÂÑÑÂÜÜ‰ª•‰∏ã„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
                },
                family: {
                    required: true,
                    message: 'ÂÆ∂ÊóèÊßãÊàê„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
                }
            },

            validateField: (fieldName, value) => {
                const rule = validation.rules[fieldName];
                if (!rule) return { valid: true };

                if (rule.required && (!value || value === '')) {
                    return { valid: false, message: rule.message };
                }

                if (rule.min && parseFloat(value) < rule.min) {
                    return { valid: false, message: rule.message };
                }

                if (rule.max && parseFloat(value) > rule.max) {
                    return { valid: false, message: rule.message };
                }

                return { valid: true };
            },

            validateForm: (formData) => {
                const errors = {};
                let isValid = true;

                Object.keys(validation.rules).forEach(fieldName => {
                    const result = validation.validateField(fieldName, formData[fieldName]);
                    if (!result.valid) {
                        errors[fieldName] = result.message;
                        isValid = false;
                    }
                });

                return { isValid, errors };
            },

            showFieldError: (fieldName, message) => {
                const field = document.getElementById(fieldName);
                const errorElement = document.getElementById(`${fieldName}-error`);
                
                if (field) {
                    field.classList.add('form-input--error');
                }
                
                if (errorElement) {
                    errorElement.textContent = message;
                }
            },

            clearFieldError: (fieldName) => {
                const field = document.getElementById(fieldName);
                const errorElement = document.getElementById(`${fieldName}-error`);
                
                if (field) {
                    field.classList.remove('form-input--error');
                }
                
                if (errorElement) {
                    errorElement.textContent = '';
                }
            },

            clearAllErrors: () => {
                Object.keys(validation.rules).forEach(fieldName => {
                    validation.clearFieldError(fieldName);
                });
            }
        };

        // Tax Calculator Module
        const calculator = {
            getTaxRate: (taxableIncome) => {
                for (const bracket of CONFIG.TAX_BRACKETS) {
                    if (taxableIncome > bracket.min && taxableIncome <= bracket.max) {
                        return bracket.rate;
                    }
                }
                return 0.05;
            },

            calculateIncomeTax: (taxableIncome) => {
                let incomeTax = 0;
                for (const bracket of CONFIG.TAX_BRACKETS) {
                    if (taxableIncome > bracket.min) {
                        const taxableAmount = Math.min(taxableIncome, bracket.max) - bracket.min;
                        incomeTax = taxableAmount * bracket.rate - bracket.deduction;
                        break;
                    }
                }
                return Math.max(0, incomeTax);
            },

            calculateLimit: (formData) => {
                const {
                    income,
                    family,
                    socialInsurance = 0,
                    lifeInsurance = 0,
                    medicalExpense = 0,
                    housingLoan = false
                } = formData;

                // Convert to yen
                const annualIncome = income * 10000;
                const socialInsuranceAmount = socialInsurance * 10000;
                const lifeInsuranceAmount = lifeInsurance * 10000;
                const medicalExpenseAmount = medicalExpense * 10000;

                // Calculate social insurance if not provided
                const estimatedSocialInsurance = socialInsuranceAmount || annualIncome * 0.14;

                // Calculate total deductions
                const basicDeduction = 480000;
                const familyDeduction = CONFIG.FAMILY_DEDUCTIONS[family] - basicDeduction;
                const totalDeductions = basicDeduction + familyDeduction + estimatedSocialInsurance + 
                                      Math.min(lifeInsuranceAmount, 120000) + medicalExpenseAmount;

                // Calculate taxable income
                const taxableIncome = Math.max(0, annualIncome - totalDeductions);

                // Calculate taxes
                let incomeTax = calculator.calculateIncomeTax(taxableIncome);
                const residentTax = taxableIncome * 0.10;

                // Apply housing loan deduction
                if (housingLoan) {
                    incomeTax = Math.max(0, incomeTax - Math.min(annualIncome * 0.01, 400000));
                }

                // Calculate furusato tax limit
                const taxRate = calculator.getTaxRate(taxableIncome);
                const limit = Math.floor((residentTax * 0.20) / (0.90 - taxRate) + 2000);

                return {
                    limit,
                    recommendAmount: Math.floor(limit * 0.95),
                    taxSaving: limit - 2000,
                    returnRate: Math.floor(((limit - 2000) / limit) * 100),
                    incomeTax,
                    residentTax,
                    taxableIncome,
                    annualIncome
                };
            }
        };

        // History Management
        const historyManager = {
            loadHistory: () => {
                try {
                    const stored = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY) || '[]');
                    app.history = stored;
                    historyManager.renderHistory();
                } catch (error) {
                    console.error('Failed to load history:', error);
                    app.history = [];
                }
            },

            saveHistory: () => {
                try {
                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(app.history));
                } catch (error) {
                    console.error('Failed to save history:', error);
                }
            },

            addToHistory: (formData, result) => {
                const historyItem = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('ja-JP'),
                    income: formData.income,
                    family: formData.family,
                    limit: result.limit,
                    timestamp: Date.now()
                };

                app.history.unshift(historyItem);
                
                if (app.history.length > CONFIG.MAX_HISTORY_ITEMS) {
                    app.history = app.history.slice(0, CONFIG.MAX_HISTORY_ITEMS);
                }

                historyManager.saveHistory();
                historyManager.renderHistory();
            },

            clearHistory: () => {
                app.history = [];
                historyManager.saveHistory();
                historyManager.renderHistory();
                utils.showNotification('Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'success');
            },

            renderHistory: () => {
                if (!elements.historyList) return;

                if (app.history.length === 0) {
                    elements.historyList.innerHTML = '<p class="text-center" style="color: #999;">„Åæ„Å†Ë®àÁÆóÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                    elements.clearHistoryBtn.style.display = 'none';
                    return;
                }

                const familyNames = {
                    'single': 'Áã¨Ë∫´„ÉªÂÖ±ÂÉç„Åç',
                    'married_working': 'Â§´Â©¶ÂÖ±ÂÉç„Åç',
                    'married_housewife': 'Â§´Â©¶ÔºàÈÖçÂÅ∂ËÄÖÊéßÈô§„ÅÇ„ÇäÔºâ',
                    'married_child1': 'Â§´Â©¶+Â≠ê1‰∫∫',
                    'married_child2': 'Â§´Â©¶+Â≠ê2‰∫∫',
                    'married_college1': 'Â§´Â©¶+Â§ßÂ≠¶Áîü1‰∫∫'
                };

                elements.historyList.innerHTML = app.history.map(item => `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-date">${item.date}</div>
                            <div class="history-details">Âπ¥Âèé${item.income}‰∏áÂÜÜ (${familyNames[item.family] || item.family})</div>
                        </div>
                        <div class="history-amount">${utils.formatCurrency(item.limit)}</div>
                    </div>
                `).join('');

                elements.clearHistoryBtn.style.display = 'block';
            }
        };

        // Chart Management
        const chartManager = {
            destroyCharts: () => {
                if (app.charts.tax) {
                    app.charts.tax.destroy();
                    app.charts.tax = null;
                }
                if (app.charts.saving) {
                    app.charts.saving.destroy();
                    app.charts.saving = null;
                }
            },

            createTaxChart: (result) => {
                const ctx = elements.taxChart.getContext('2d');
                app.charts.tax = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ÊâÄÂæóÁ®é', '‰ΩèÊ∞ëÁ®é', 'ÊâãÂèñ„Çä'],
                        datasets: [{
                            data: [
                                Math.round(result.incomeTax / 10000),
                                Math.round(result.residentTax / 10000),
                                Math.round((result.annualIncome - result.incomeTax - result.residentTax) / 10000)
                            ],
                            backgroundColor: [
                                '#667eea',
                                '#764ba2',
                                '#4facfe'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: { size: 14 }
                                }
                            }
                        }
                    }
                });
            },

            createSavingChart: (result) => {
                const ctx = elements.savingChart.getContext('2d');
                app.charts.saving = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['ÈÄöÂ∏∏Á¥çÁ®é', '„Åµ„Çã„Åï„Å®Á¥çÁ®éÂà©Áî®'],
                        datasets: [{
                            label: 'ÂÆüË≥™Ë≤†ÊãÖÈ°çÔºà‰∏áÂÜÜÔºâ',
                            data: [
                                Math.round((result.incomeTax + result.residentTax) / 10000),
                                Math.round((result.incomeTax + result.residentTax - result.limit + 2000) / 10000)
                            ],
                            backgroundColor: ['#ef4444', '#10b981'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        };

        // AI Advice Generator
        const aiAdvice = {
            generateAdvice: (formData, result) => {
                const income = formData.income;
                const family = formData.family;
                const limit = result.limit;

                let advice = '';

                // Income-based advice
                if (income < 300) {
                    advice = `Âπ¥Âèé${income}‰∏áÂÜÜ„ÅÆÂ†¥Âêà„ÄÅÈôêÂ∫¶È°ç„ÅØ${Math.floor(limit/10000)}‰∏áÂÜÜÁ®ãÂ∫¶„Å®„Å™„Çä„Åæ„Åô„ÄÇÂ∞ëÈ°ç„Åß„ÇÇÂäπÊûúÁöÑ„Å´Ê¥ªÁî®„Åß„Åç„Åæ„Åô„ÅÆ„Åß„ÄÅ„Åæ„Åö„ÅØÂú∞Âüü„ÅÆÁâπÁî£ÂìÅ„Åã„ÇâÂßã„ÇÅ„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ`;
                } else if (income < 500) {
                    advice = `Âπ¥Âèé${income}‰∏áÂÜÜ„Åß„ÅÆÈôêÂ∫¶È°ç${Math.floor(limit/10000)}‰∏áÂÜÜ„ÅØ„ÄÅ„Éê„É©„É≥„Çπ„ÅÆËâØ„ÅÑÂØÑ‰ªò„ÅåÂèØËÉΩ„Åß„Åô„ÄÇËøîÁ§ºÂìÅ„ÅÆÈÇÑÂÖÉÁéá„ÅåÈ´ò„ÅÑËá™Ê≤ª‰Ωì„ÇíÈÅ∏„Å∂„Åì„Å®„Åß„ÄÅÂÆüË≥™ÁöÑ„Å™ÁØÄÁ®éÂäπÊûú„ÇíÊúÄÂ§ßÂåñ„Åß„Åç„Åæ„Åô„ÄÇ`;
                } else if (income < 800) {
                    advice = `Âπ¥Âèé${income}‰∏áÂÜÜ„ÅÆÊñπ„ÅØ„ÄÅÈôêÂ∫¶È°ç${Math.floor(limit/10000)}‰∏áÂÜÜ„ÇíÊ¥ªÁî®„Åó„Å¶„ÄÅÈ´òÈ°çËøîÁ§ºÂìÅ„ÇÇË¶ñÈáé„Å´ÂÖ•„Çå„Çâ„Çå„Åæ„Åô„ÄÇÂÆ∂ÈõªË£ΩÂìÅ„ÇÑÊóÖË°åÂà∏„Å™„Å©„ÄÅ„É©„Ç§„Éï„Çπ„Çø„Ç§„É´„Å´Âêà„Å£„ÅüËøîÁ§ºÂìÅ„ÇíÈÅ∏Êäû„Åô„Çã„Åì„Å®„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô„ÄÇ`;
                } else {
                    advice = `È´òÊâÄÂæóËÄÖ„ÅÆÊñπ„ÅØÈôêÂ∫¶È°ç${Math.floor(limit/10000)}‰∏áÂÜÜ„ÇíÊà¶Áï•ÁöÑ„Å´Ê¥ªÁî®„Åß„Åç„Åæ„Åô„ÄÇË§áÊï∞„ÅÆËá™Ê≤ª‰Ωì„Å´ÂàÜÊï£„Åó„Å¶ÂØÑ‰ªò„Åô„Çã„Åì„Å®„Åß„ÄÅ„É™„Çπ„ÇØÂàÜÊï£„Å®Â§öÊßò„Å™ËøîÁ§ºÂìÅ„ÅÆÁç≤Âæó„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ`;
                }

                // Family-specific advice
                const familyAdvice = {
                    'single': 'Áã¨Ë∫´„ÅÆÊñπ„ÅØËá™Áî±Â∫¶„ÅåÈ´ò„ÅÑ„ÅÆ„Åß„ÄÅË∂£Âë≥„ÇÑÂóúÂ•ΩÂìÅ„Å´ÁâπÂåñ„Åó„ÅüËøîÁ§ºÂìÅ„Åå„Åä„Åô„Åô„ÇÅ„Åß„Åô„ÄÇ',
                    'married_working': 'ÂÖ±ÂÉç„Åç‰∏ñÂ∏Ø„ÅØ„ÄÅ‰∏°Êñπ„ÅÆÂèéÂÖ•„ÅßË®àÁÆó„Åô„Çã„Åì„Å®„Åß„ÄÅ„Çà„ÇäÂ§ö„Åè„ÅÆÂØÑ‰ªò„ÅåÂèØËÉΩ„Å´„Å™„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ',
                    'married_housewife': 'ÈÖçÂÅ∂ËÄÖÊéßÈô§„ÇíÂèó„Åë„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ‰∏ñÂ∏ØÂÖ®‰Ωì„Åß„ÅÆÊúÄÈÅ©Âåñ„ÇíÊ§úË®é„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    'married_child1': '„ÅäÂ≠êÊßò„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅÊïôËÇ≤Èñ¢ÈÄ£„ÅÆËøîÁ§ºÂìÅ„ÇÑÊó•Áî®ÂìÅ„Åå„Åä„Åô„Åô„ÇÅ„Åß„Åô„ÄÇ',
                    'married_child2': 'Â§ßÂÆ∂ÊóèÂêë„Åë„ÅÆÂ§ßÂÆπÈáèËøîÁ§ºÂìÅ„ÇíÈÅ∏„Å∂„Åì„Å®„Åß„ÄÅÂÆüË≥™ÁöÑ„Å™ÂÆ∂Ë®à„ÅÆÂä©„Åë„Å´„Å™„Çä„Åæ„Åô„ÄÇ',
                    'married_college1': 'Â§ßÂ≠¶Áîü„ÅÆ„ÅäÂ≠êÊßò„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅÊïôËÇ≤Ë≤ª„Å®„ÅÆÂÖº„Å≠Âêà„ÅÑ„ÇíËÄÉÊÖÆ„Åó„ÅüË®àÁîªÁöÑ„Å™ÂØÑ‰ªò„ÅåÈáçË¶Å„Åß„Åô„ÄÇ'
                };

                advice += ' ' + (familyAdvice[family] || '');

                return advice;
            }
        };

        // Animation Utils
        const animations = {
            animateValue: (element, start, end, duration, formatter = utils.formatCurrency) => {
                if (!element) return;

                const range = end - start;
                const startTime = Date.now();

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const current = start + (range * this.easeOutCubic(progress));
                    
                    element.textContent = formatter(current);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };

                requestAnimationFrame(animate);
            },

            easeOutCubic: (t) => 1 - Math.pow(1 - t, 3)
        };

        // Event Handlers
        const handlers = {
            handleFormSubmit: async (e) => {
                e.preventDefault();
                
                // Clear previous errors
                validation.clearAllErrors();

                // Get form data
                const formData = new FormData(elements.form);
                const data = {
                    income: parseInt(formData.get('income')) || 0,
                    family: formData.get('family'),
                    socialInsurance: parseInt(formData.get('socialInsurance')) || 0,
                    lifeInsurance: parseInt(formData.get('lifeInsurance')) || 0,
                    medicalExpense: parseInt(formData.get('medicalExpense')) || 0,
                    housingLoan: formData.get('housingLoan') === 'on'
                };

                // Validate form
                const validationResult = validation.validateForm(data);
                if (!validationResult.isValid) {
                    Object.entries(validationResult.errors).forEach(([field, message]) => {
                        validation.showFieldError(field, message);
                    });
                    return;
                }

                // Show loading
                elements.loading.style.display = 'block';
                elements.form.style.display = 'none';

                try {
                    // Simulate calculation delay
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    // Calculate result
                    const result = calculator.calculateLimit(data);
                    app.currentResult = result;

                    // Display results
                    handlers.displayResults(result);
                    
                    // Show AI advice
                    const advice = aiAdvice.generateAdvice(data, result);
                    elements.aiAdvice.textContent = advice;
                    elements.aiAssistant.style.display = 'block';

                    // Create charts
                    chartManager.destroyCharts();
                    chartManager.createTaxChart(result);
                    chartManager.createSavingChart(result);

                    // Add to history
                    historyManager.addToHistory(data, result);

                    // Show result section
                    elements.resultSection.style.display = 'block';
                    
                    // Show affiliate message
                    elements.affiliateMessage.style.display = 'block';

                    // Scroll to results
                    elements.resultSection.scrollIntoView({ behavior: 'smooth' });

                    // Track conversion
                    handlers.trackConversion(data, result);

                } catch (error) {
                    console.error('Calculation error:', error);
                    utils.showNotification('Ë®àÁÆó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                } finally {
                    // Hide loading
                    elements.loading.style.display = 'none';
                    elements.form.style.display = 'block';
                }
            },

            displayResults: (result) => {
                // Animate result values
                animations.animateValue(elements.resultAmount, 0, result.limit, 2000);
                animations.animateValue(elements.recommendAmount, 0, result.recommendAmount, 2000);
                animations.animateValue(elements.taxSaving, 0, result.taxSaving, 2000);
                animations.animateValue(elements.returnRate, 0, result.returnRate, 2000, (value) => `${Math.floor(value)}%`);
            },

            handleIncomeInput: utils.debounce((e) => {
                const income = parseInt(e.target.value || 0);
                if (income > 0) {
                    const estimatedSocialInsurance = Math.floor(income * 0.14);
                    const socialInsuranceInput = document.getElementById('socialInsurance');
                    if (!socialInsuranceInput.value || socialInsuranceInput.value === '0') {
                        socialInsuranceInput.value = estimatedSocialInsurance;
                    }
                }
            }, 300),

            trackConversion: (formData, result) => {
                // Google Analytics tracking
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'calculation_completed', {
                        'event_category': 'engagement',
                        'event_label': 'furusato_tax_calculation',
                        'value': Math.floor(result.limit / 1000),
                        'income_range': formData.income < 400 ? 'low' : formData.income < 800 ? 'medium' : 'high',
                        'family_type': formData.family
                    });
                }

                // GTM DataLayer
                if (typeof dataLayer !== 'undefined') {
                    dataLayer.push({
                        'event': 'calculation_completed',
                        'calculation_amount': result.limit,
                        'user_income': formData.income,
                        'family_composition': formData.family
                    });
                }
            }
        };

        // Affiliate Tracking
        const affiliateTracking = {
            trackClick: (siteName) => {
                const result = app.currentResult;
                
                // Google Analytics
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'affiliate_click', {
                        'event_category': 'affiliate',
                        'event_label': siteName,
                        'value': result ? Math.floor(result.limit / 1000) : 0,
                        'calculated_limit': result ? result.limit : 0
                    });
                }

                // GTM DataLayer
                if (typeof dataLayer !== 'undefined') {
                    dataLayer.push({
                        'event': 'affiliate_click',
                        'affiliate_site': siteName,
                        'calculated_limit': result ? result.limit : 0,
                        'timestamp': new Date().toISOString()
                    });
                }

                console.log(`Affiliate click tracked: ${siteName}`);
            }
        };

        // Share Functions
        const sharing = {
            shareTwitter: () => {
                const result = app.currentResult;
                const amount = result ? utils.formatCurrency(result.limit) : 'ÈôêÂ∫¶È°ç';
                const text = `„Åµ„Çã„Åï„Å®Á¥çÁ®éÈôêÂ∫¶È°ç„ÇíË®àÁÆó„Åó„Åæ„Åó„ÅüÔºÅÁßÅ„ÅÆÈôêÂ∫¶È°ç„ÅØ${amount}„Åß„Åó„Åü„ÄÇ #„Åµ„Çã„Åï„Å®Á¥çÁ®é #ÁØÄÁ®é #Á∂ôÁ∂ö„ÅØÂäõ„Å™„Çä`;
                const url = window.location.href;
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
            },

            shareFacebook: () => {
                const url = window.location.href;
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
            },

            shareLine: () => {
                const result = app.currentResult;
                const amount = result ? utils.formatCurrency(result.limit) : 'ÈôêÂ∫¶È°ç';
                const text = `„Åµ„Çã„Åï„Å®Á¥çÁ®éÈôêÂ∫¶È°çË®àÁÆó„ÉÑ„Éº„É´„Åß${amount}„Å®Ë®àÁÆó„Åï„Çå„Åæ„Åó„ÅüÔºÅ`;
                const url = window.location.href;
                window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
            },

            copyLink: async () => {
                try {
                    await navigator.clipboard.writeText(window.location.href);
                    utils.showNotification('„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                } catch (error) {
                    console.error('Failed to copy link:', error);
                    utils.showNotification('„É™„É≥„ÇØ„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            }
        };

        // Global Functions (for onclick handlers)
        window.trackAffiliateClick = affiliateTracking.trackClick;
        window.shareTwitter = sharing.shareTwitter;
        window.shareFacebook = sharing.shareFacebook;
        window.shareLine = sharing.shareLine;
        window.copyLink = sharing.copyLink;

        // Initialize Application
        const init = () => {
            // Load history
            historyManager.loadHistory();

            // Add event listeners
            elements.form.addEventListener('submit', handlers.handleFormSubmit);
            document.getElementById('income').addEventListener('input', handlers.handleIncomeInput);
            elements.clearHistoryBtn.addEventListener('click', historyManager.clearHistory);

            // Add input validation on blur
            Object.keys(validation.rules).forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (field) {
                    field.addEventListener('blur', (e) => {
                        const result = validation.validateField(fieldName, e.target.value);
                        if (!result.valid) {
                            validation.showFieldError(fieldName, result.message);
                        } else {
                            validation.clearFieldError(fieldName);
                        }
                    });
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    elements.form.dispatchEvent(new Event('submit'));
                }
            });

            console.log('„Åµ„Çã„Åï„Å®Á¥çÁ®éÈôêÂ∫¶È°çË®àÁÆó„ÉÑ„Éº„É´ initialized successfully');
        };

        // Start application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Service Worker Registration (Optional - for PWA features)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Implement service worker for offline functionality
                // navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
</body>
</html>