<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ふるさと納税限度額計算ツール | 30日連続開発チャレンジ</title>
    <meta name="description" content="年収から1クリックでふるさと納税の限度額を計算！税制に基づいた正確な計算で、損しないふるさと納税をサポートします。">
    <meta name="keywords" content="ふるさと納税,限度額,計算,税金,控除,節税">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://appadaycreator.github.io/furusato-tax-calculator/">
    <meta property="og:title" content="ふるさと納税限度額計算ツール">
    <meta property="og:description" content="年収から1クリックでふるさと納税の限度額を計算！">
    <meta property="og:image" content="https://appadaycreator.github.io/furusato-tax-calculator/og-image.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://appadaycreator.github.io/furusato-tax-calculator/">
    <meta property="twitter:title" content="ふるさと納税限度額計算ツール">
    <meta property="twitter:description" content="年収から1クリックでふるさと納税の限度額を計算！">
    <meta property="twitter:image" content="https://appadaycreator.github.io/furusato-tax-calculator/og-image.jpg">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏛️</text></svg>">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TXQGZRF9');</script>
    <!-- End Google Tag Manager -->

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .calculator-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 1rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.2);
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .result-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            display: none;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
        }

        .result-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .affiliate-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
        }

        .affiliate-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .affiliate-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .affiliate-btn {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid;
        }

        .satofull {
            background: #FF6B6B;
            color: white;
            border-color: #FF6B6B;
        }

        .rakuten {
            background: #BF0000;
            color: white;
            border-color: #BF0000;
        }

        .furunavi {
            background: #4ECDC4;
            color: white;
            border-color: #4ECDC4;
        }

        .affiliate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .note {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 10px 10px 0;
            font-size: 0.9rem;
            color: #666;
        }

        .history-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }

        .history-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .clear-history {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .clear-history:hover {
            background: #ff5252;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .calculator-card {
                padding: 20px;
            }

            .affiliate-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TXQGZRF9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
        <div class="header">
            <h1>🏛️ ふるさと納税限度額計算ツール</h1>
            <p>年収から1クリックで正確な限度額を計算</p>
        </div>

        <div class="calculator-card">
            <form id="taxForm">
                <div class="form-group">
                    <label for="income">年収（万円）</label>
                    <input type="number" id="income" name="income" placeholder="例: 500" required>
                </div>

                <div class="form-group">
                    <label for="family">家族構成</label>
                    <select id="family" name="family" required>
                        <option value="">選択してください</option>
                        <option value="single">独身・共働き</option>
                        <option value="married_working">夫婦共働き</option>
                        <option value="married_housewife">夫婦（配偶者控除あり）</option>
                        <option value="married_child1">夫婦+子1人（19歳以下）</option>
                        <option value="married_child2">夫婦+子2人（19歳以下）</option>
                        <option value="married_college1">夫婦+大学生1人</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="socialInsurance">社会保険料控除（万円）</label>
                    <input type="number" id="socialInsurance" name="socialInsurance" placeholder="例: 70" value="0">
                </div>

                <div class="form-group">
                    <label for="lifeInsurance">生命保険料控除（万円）</label>
                    <input type="number" id="lifeInsurance" name="lifeInsurance" placeholder="例: 12" value="0">
                </div>

                <div class="form-group">
                    <label for="medicalExpense">医療費控除（万円）</label>
                    <input type="number" id="medicalExpense" name="medicalExpense" placeholder="例: 10" value="0">
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="housingLoan" name="housingLoan">
                        <label for="housingLoan">住宅ローン控除あり</label>
                    </div>
                </div>

                <button type="submit" class="calculate-btn">限度額を計算する</button>
            </form>
        </div>

        <div id="result" class="result-card">
            <h3 style="margin-bottom: 20px; text-align: center;">計算結果</h3>
            <div class="result-item">
                <span class="result-label">ふるさと納税限度額</span>
                <span class="result-value" id="taxLimit">0円</span>
            </div>
            <div class="result-item">
                <span class="result-label">実質負担額</span>
                <span class="result-value">2,000円</span>
            </div>
            <div class="result-item">
                <span class="result-label">おすすめ寄付額</span>
                <span class="result-value" id="recommendAmount">0円</span>
            </div>
        </div>

        <div class="note">
            <strong>⚠️ 注意事項：</strong>
            この計算結果は概算です。正確な限度額は、確定申告や住民税の計算によって決定されます。
            寄付前に必ず自治体や税理士にご相談ください。
        </div>

        <div class="affiliate-section">
            <h3 class="affiliate-title">💝 おすすめふるさと納税サイト</h3>
            <p>計算した限度額でお得な返礼品を見つけよう！</p>
            <div class="affiliate-buttons">
                <a href="https://www.satofull.jp/" target="_blank" class="affiliate-btn satofull" rel="noopener">
                    さとふる<br><small>豊富な返礼品</small>
                </a>
                <a href="https://event.rakuten.co.jp/furusato/" target="_blank" class="affiliate-btn rakuten" rel="noopener">
                    楽天ふるさと納税<br><small>楽天ポイント還元</small>
                </a>
                <a href="https://furunavi.jp/" target="_blank" class="affiliate-btn furunavi" rel="noopener">
                    ふるなび<br><small>家電も充実</small>
                </a>
            </div>
        </div>

        <div class="history-card">
            <h3 style="margin-bottom: 15px;">計算履歴</h3>
            <div id="historyList">
                <p style="color: #999; text-align: center;">まだ計算履歴がありません</p>
            </div>
            <button id="clearHistory" class="clear-history" style="display: none; margin-top: 15px;">履歴をクリア</button>
        </div>
    </div>

    <script>
        // 税率と控除額の定義
        const TAX_BRACKETS = [
            { min: 0, max: 1950000, rate: 0.05, deduction: 0 },
            { min: 1950000, max: 3300000, rate: 0.10, deduction: 97500 },
            { min: 3300000, max: 6950000, rate: 0.20, deduction: 427500 },
            { min: 6950000, max: 9000000, rate: 0.23, deduction: 636000 },
            { min: 9000000, max: 18000000, rate: 0.33, deduction: 1536000 },
            { min: 18000000, max: 40000000, rate: 0.40, deduction: 2796000 },
            { min: 40000000, max: Infinity, rate: 0.45, deduction: 4796000 }
        ];

        // 家族構成別控除額
        const FAMILY_DEDUCTIONS = {
            'single': 480000,
            'married_working': 480000,
            'married_housewife': 480000 + 380000,
            'married_child1': 480000 + 380000 + 380000,
            'married_child2': 480000 + 380000 + 380000 * 2,
            'married_college1': 480000 + 380000 + 630000
        };

        document.getElementById('taxForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateTaxLimit();
        });

        function calculateTaxLimit() {
            const income = parseInt(document.getElementById('income').value) * 10000;
            const family = document.getElementById('family').value;
            const socialInsurance = parseInt(document.getElementById('socialInsurance').value || 0) * 10000;
            const lifeInsurance = parseInt(document.getElementById('lifeInsurance').value || 0) * 10000;
            const medicalExpense = parseInt(document.getElementById('medicalExpense').value || 0) * 10000;
            const housingLoan = document.getElementById('housingLoan').checked;

            if (!income || !family) {
                alert('年収と家族構成を入力してください。');
                return;
            }

            // 社会保険料の概算（年収の約14%）
            const estimatedSocialInsurance = socialInsurance || income * 0.14;

            // 所得控除の合計
            const basicDeduction = 480000; // 基礎控除
            const familyDeduction = FAMILY_DEDUCTIONS[family] - basicDeduction;
            const totalDeductions = basicDeduction + familyDeduction + estimatedSocialInsurance + 
                                  Math.min(lifeInsurance, 120000) + medicalExpense;

            // 課税所得
            const taxableIncome = Math.max(0, income - totalDeductions);

            // 所得税の計算
            let incomeTax = 0;
            for (const bracket of TAX_BRACKETS) {
                if (taxableIncome > bracket.min) {
                    const taxableAmount = Math.min(taxableIncome, bracket.max) - bracket.min;
                    incomeTax = taxableAmount * bracket.rate - bracket.deduction;
                    break;
                }
            }

            // 住民税（課税所得の10%）
            const residentTax = taxableIncome * 0.10;

            // 住宅ローン控除の影響（簡易計算）
            let adjustedIncomeTax = incomeTax;
            if (housingLoan) {
                adjustedIncomeTax = Math.max(0, incomeTax - income * 0.01); // 概算1%減税
            }

            // ふるさと納税限度額の計算
            // (個人住民税所得割額 × 20%) ÷ (90% - 所得税率) + 2,000円
            const taxRate = getTaxRate(taxableIncome);
            const limit = Math.floor((residentTax * 0.20) / (0.90 - taxRate) + 2000);

            // おすすめ寄付額（限度額の95%）
            const recommendAmount = Math.floor(limit * 0.95);

            // 結果表示
            document.getElementById('taxLimit').textContent = limit.toLocaleString() + '円';
            document.getElementById('recommendAmount').textContent = recommendAmount.toLocaleString() + '円';
            document.getElementById('result').style.display = 'block';

            // 履歴に追加
            addToHistory(income / 10000, family, limit);

            // アフィリエイトリンククリック追跡
            trackAffiliateClicks(limit);

            // スクロール
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }

        function getTaxRate(taxableIncome) {
            for (const bracket of TAX_BRACKETS) {
                if (taxableIncome > bracket.min && taxableIncome <= bracket.max) {
                    return bracket.rate;
                }
            }
            return 0.05; // デフォルト
        }

        // localStorage使用版（GitHub Pages用）
        function addToHistory(income, family, limit) {
            try {
                const history = JSON.parse(localStorage.getItem('furusatoHistory') || '[]');
                const familyNames = {
                    'single': '独身・共働き',
                    'married_working': '夫婦共働き',
                    'married_housewife': '夫婦（配偶者控除あり）',
                    'married_child1': '夫婦+子1人',
                    'married_child2': '夫婦+子2人',
                    'married_college1': '夫婦+大学生1人'
                };

                history.unshift({
                    date: new Date().toLocaleDateString(),
                    income: income,
                    family: familyNames[family],
                    limit: limit
                });

                // 最新5件のみ保持
                if (history.length > 5) {
                    history.pop();
                }

                localStorage.setItem('furusatoHistory', JSON.stringify(history));
                displayHistory();
            } catch (error) {
                console.log('LocalStorage not available, using session storage');
                // localStorageが使用できない場合はセッション中のみ保存
            }
        }

        function displayHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('furusatoHistory') || '[]');
                const historyList = document.getElementById('historyList');
                const clearBtn = document.getElementById('clearHistory');

                if (history.length === 0) {
                    historyList.innerHTML = '<p style="color: #999; text-align: center;">まだ計算履歴がありません</p>';
                    clearBtn.style.display = 'none';
                    return;
                }

                historyList.innerHTML = history.map(item => 
                    `<div class="history-item">
                        <div>
                            <strong>${item.date}</strong><br>
                            年収${item.income}万円 (${item.family})
                        </div>
                        <div style="text-align: right;">
                            <strong>${item.limit.toLocaleString()}円</strong>
                        </div>
                    </div>`
                ).join('');

                clearBtn.style.display = 'block';
            } catch (error) {
                console.log('LocalStorage not available');
            }
        }

        document.getElementById('clearHistory').addEventListener('click', function() {
            try {
                localStorage.removeItem('furusatoHistory');
                displayHistory();
            } catch (error) {
                console.log('LocalStorage not available');
            }
        });

        // アフィリエイトリンク追跡
        function trackAffiliateClicks(calculatedAmount) {
            document.querySelectorAll('.affiliate-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Google Analytics追跡
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'affiliate_click', {
                            'affiliate_site': this.textContent.trim().split('\n')[0],
                            'calculation_amount': calculatedAmount,
                            'event_category': 'affiliate',
                            'event_label': 'furusato_site_click'
                        });
                    }
                });
            });
        }

        // ページ読み込み時に履歴を表示
        displayHistory();

        // 年収入力時の自動社会保険料計算
        document.getElementById('income').addEventListener('input', function() {
            const income = parseInt(this.value || 0);
            if (income > 0) {
                const estimatedSocialInsurance = Math.floor(income * 0.14);
                const socialInsuranceInput = document.getElementById('socialInsurance');
                if (socialInsuranceInput.value === '0' || socialInsuranceInput.value === '') {
                    socialInsuranceInput.value = estimatedSocialInsurance;
                }
            }
        });
    </script>
</body>
</html>